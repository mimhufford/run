<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Run</title>
    <style>
        * {
            font-family: monospace;
            font-size: xx-large;
        }
    </style>
</head>

<body>
    <div id="output"></div>
    <button id="action" onclick="action()">Start</button>
    <script>
        let state = "stopped"
        let gps, positions, totalDistance, nextUpdate
        const updateFreqKm = 0.1
        
        const speak = text => window.speechSynthesis.speak(new SpeechSynthesisUtterance(text))

        const distance = (a, b) => {
            const square = n => Math.pow(n, 2)
            const lon1 = a.lon * Math.PI / 180
            const lon2 = b.lon * Math.PI / 180
            const lat1 = a.lat * Math.PI / 180
            const lat2 = b.lat * Math.PI / 180
            return 12742 * Math.asin(Math.sqrt(square(Math.sin((lat2 - lat1) / 2)) + Math.cos(lat1) * Math.cos(lat2) * square(Math.sin((lon2 - lon1) / 2))))
        }

        const handleReading = (pos) => {
            // early out on first reading as there is nothing to diff against
            if (positions.length == 0) { positions.push(pos); return }

            // first two readings seem to be the same, not sure if this happens more later
            // either way, only push positions if they're different to the previous one
            const prev = positions[positions.length - 1]
            if (pos.lat == prev.lat && pos.lon == prev.lon) return
            positions.push(pos)

            // calculate delta between last two readings
            const a = positions[positions.length - 1]
            const b = positions[positions.length - 2]
            const dt = (a.time - b.time) / 1000
            const dp = distance(a, b)
            totalDistance += dp

            const totaltime = (positions[positions.length - 1].time - positions[0].time) / 1000

            const output = document.querySelector("#output")
            output.innerText = ''
            output.innerText += `Last Time Diff: ${dt.toFixed(2)} seconds\n`
            output.innerText += `Last Dist Diff: ${dp} km\n`
            output.innerText += `\n`
            output.innerText += `----Total Time: ${totaltime.toFixed(2)} seconds\n`
            output.innerText += `----Total Dist: ${totalDistance.toFixed(2)} km\n`
            output.innerText += `-Average Speed: ${(totalDistance / totaltime * 60).toFixed(2)} km/min\n`
            output.innerText += `--Average Pace: ${(1 / (totalDistance / totaltime * 60)).toFixed(2)} min/km\n`

            if (totalDistance >= nextUpdate) {
                speak((1 / (totalDistance / totaltime * 60)).toFixed(2))
                nextUpdate += updateFreqKm
            }
        }

        const action = () => {
            const btn = document.querySelector("#action")
            if (state == "stopped") {
                btn.textContent = "Stop"
                state = "tracking"
                positions = []
                nextUpdate = updateFreqKm
                totalDistance = 0
                gps = navigator.geolocation.watchPosition(pos => {
                    handleReading({ lat: pos.coords.latitude, lon: pos.coords.longitude, time: pos.timestamp })
                })
                speak("starting run")
            }
            else if (state == "tracking") {
                btn.textContent = "Start"
                state = "stopped"
                navigator.geolocation.clearWatch(gps)
                speak("stopping run")
            }
        }
    </script>
</body>

</html>